<?php
/**
 * @file check_import.drush.inc
 *
 * Import checks processed offline into CiviCRM from a CSV
 *
 * @author Peter Gehres <pgehres@wikimedia.org>
 */

if ( function_exists( 'drupal_get_path' ) ) {
	require_once( drupal_get_path( 'module', 'queue2civicrm' ) . '/queue2civicrm_db_switcher.inc' );
	require_once( drupal_get_path( 'module', 'queue2civicrm' ) . '/queue2civicrm_stomp.inc' );
}

/**
 * Implementation of hook_drush_command()
 */
function import_checks_drush_command() {
  $items = array();

  $items['import-checks'] = array(
    'description' => 
      'Import checks processed offline into CiviCRM from a CSV',
    'examples' => array( 'drush import-checks filename.csv' ),
//    'aliases' => array( 'ic' ),
  	'required-arguments' => true,
	'arguments' => array(
		'file' => 'Name of CSV file to process'
	)
  );

  return $items;
}

/**
 * Implementation of hook_drush_help()
 */
function import_checks_drush_help( $section ) {
  switch ( $section ) {
    case 'drush:import-checks':
      return dt( "Import checks processed offline into CiviCRM from a CSV" );
  }
}

/**
 * Fires the 'batch_process' method in the queue2civicrm module.
 */
function drush_import_checks() {
	global $dbs;

	try{
		$dbs = new queue2civicrm_db_switcher();

		$args = drush_get_arguments();
		$filename = $args[1];

		if( ( $file = fopen( $filename, 'r' )) === FALSE ){
			watchdog('offline2civicrm', 'Import checks: Could not open file for reading: ' . $filename, array(), WATCHDOG_ERROR);
		}

		$headers = _load_headers( fgetcsv( $file, 0, ',', '"', '\\') );

		while( ( $row = fgetcsv( $file, 0, ',', '"', '\\')) !== FALSE) {
			// The following is fairly specific to the format received for the 2011 fundraiser
			// in csv's generated by Merkle. This may be to be tweaked if a new format is used
			$msg = array(
				"optout" => "1",
				"anonymous" => "0",
				"utm_source" =>  _get_value( "Payment Instrument", $row, $headers ),
				"utm_medium" => str_replace(' ', '', _get_value( "Appeal", $row, $headers ) ),
				"letter_code" => _get_value( "Letter Code", $row, $headers ),
				"contact_source" => "check",
				"language" => "en",
				"street_address" => _get_value( "Street Address", $row, $headers ),
				"supplemental_address_1" => _get_value( "Additional Address 1", $row, $headers ),
				"city" => _get_value( "City", $row, $headers ),
				"state_province" => _get_value( "State", $row, $headers ),
				"postal_code" => _get_value( "Postal Code", $row, $headers ),
				"gateway" => "check",
				"payment_method" => _get_value( "Payment Instrument", $row, $headers ),
				"payment_submethod" => "",
				"check_number" => _get_value( "Check Number", $row, $headers ),
				"currency" => substr( _get_value( "Source", $row, $headers ), 0, strpos( _get_value( "Source", $row, $headers ), ' ' ) + 1 ),
				"original_currency" => substr( _get_value( "Source", $row, $headers ), 0, strpos( _get_value( "Source", $row, $headers ), ' ' ) + 1 ),
				"original_gross" => _get_value( "Total Amount", $row, $headers ),
				"fee" => "0",
				"gross" => _get_value( "Total Amount", $row, $headers ),
				"net" => _get_value( "Total Amount", $row, $headers ),
				"date" => strtotime( _get_value( "Received Date", $row, $headers ) )
			);

			if( _get_value( 'Organization Name', $row, $headers, FALSE ) === FALSE ){
				$msg['contact_type'] = "Individual";
				$msg["first_name"] = _get_value( "First Name", $row, $headers );
				$msg["middle_name"] = _get_value( "Middle Name", $row, $headers );
				$msg["last_name"] = _get_value( "Last Name", $row, $headers );
			} else {
				$msg['contact_type'] = "Organization";
				$msg['organization_name'] = _get_value( "Organization Name", $row, $headers );
			}

			// check for additional address information
			if( _get_value( 'Additional Address 2', $row, $headers ) != ''){
				$msg['supplemental_address_1'] .= ' ' . _get_value( 'Additional Address 2', $row, $headers );
			}

			// An email address is one of the crucial fields we need
			if( _get_value( 'Email', $row, $headers ) == ''){
				// set to the default, no TY will be sent
				$msg['email'] = "nobody@wikimedia.org";
			} else {
				$msg['email'] = _get_value( 'Email', $row, $headers );
			}

			// CiviCRM gets all weird when there is no country set
			// Making the assumption that none = US
			if( _get_value( 'Country', $row, $headers ) == ''){
				// set to the default, no TY will be sent
				$msg['country'] = "US";
			} else {
				$msg['country'] = _get_value( 'Country', $row, $headers );
			}

			// Generating a transaction id so that we don't import the same rows multiple times
			$name_salt = $msg['contact_type'] == "Individual" ? $msg["first_name"] . $msg["last_name"] : $msg["organization_name"];
			$msg['gateway_txn_id'] = md5( $msg['check_number'] . $name_salt );

			// check to see if we have already processed this check
			if ( $existing = _check_existing( $msg ) ){
				// if so, move on
				watchdog('offline2civicrm', 'Contribution matches existing contribution (id: ' . $existing['id'] .
					') Skipping', array(), WATCHDOG_INFO);
				continue;
			}

			if ( sendSTOMP( $msg ) ){
				watchdog('offline2civicrm', 'Import checks: Message sent to stomp successfully: ' . print_r( $msg, true ), array(), WATCHDOG_INFO);
			} else {
				watchdog('offline2civicrm', 'Import checks: Sending message to stomp failed: ' . print_r( $msg, true ), array(), WATCHDOG_ERROR);
			}
		}
	} catch ( Exception $e ){
		watchdog('offline2civicrm', 'Import checks: Exception thrown during check processing: ' . print_r( $e, true ), array(), WATCHDOG_ERROR);
	}
}

/**
 * Loads the column headers into an array so that they can be used independent
 * of the column order when generating messages
 *
 * @param $row Array containing the column headers for the csv
 * @return Array mapping the header keys to the column index
 */
function _load_headers( $row ){
	$header_keys = array();

	# trimming the " from each side
	foreach( $row as $i => $k ) {
		$header_keys[trim( $k, '"' )] = $i;
	}
	watchdog('offline2civicrm', 'Import checks: Column headers loaded from file', array(), WATCHDOG_INFO);

	return $header_keys;
}

function _get_value( $column, $row, $headers, $default='' ){

	if( !array_key_exists( $column, $headers ) ){
		return $default;
	} else {
		return $row[ $headers[ $column ] ];
	}
}

function _check_existing( $msg ){
	global $dbs;

	$trxn_id = $msg['payment_method'] . ' ' . $msg['gateway_txn_id'];
	$dbs->use_civicrm();
	$query = "SELECT id, trxn_id FROM civicrm_contribution WHERE trxn_id LIKE '" . $trxn_id . "%' LIMIT 1;";
	$dao = CRM_Core_DAO::executeQuery( $query ); // Execute's query using CiviCRM data object stuff
	while( $dao->fetch() ) {
		$contribution = array(
			'id' => $dao->id,
			'trxn_id' => $dao->trxn_id,
		);
		$dbs->use_default();

		return $contribution;
	}
	$dbs->use_default();
	return false;
}